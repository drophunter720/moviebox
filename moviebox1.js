(()=>{document.addEventListener("DOMContentLoaded",()=>{function Y(P){let J={};async function M(){try{let[R,s]=await Promise.all([fetch(`https://api.themoviedb.org/3/genre/movie/list?api_key=${P}&language=en-US`).then(l=>l.json()),fetch(`https://api.themoviedb.org/3/genre/tv/list?api_key=${P}&language=en-US`).then(l=>l.json())]);[...R.genres||[],...s.genres||[]].forEach(l=>J[l.id]=l.name)}catch(R){console.error("Failed to load genres:",R)}}let D=document.querySelector(".search-input"),_=document.getElementById("search-results");if(D&&_){let s=function(a){_.innerHTML="";let v=a.filter(E=>["movie","tv"].includes(E.media_type)&&E.poster_path).slice(0,6);if(v.length===0){_.style.display="none";return}v.forEach(async E=>{let x=E.title||E.name||"Untitled",H=`https://image.tmdb.org/t/p/w92${E.poster_path}`,O=(E.release_date||E.first_air_date||"").split("-")[0]||"N/A",F=E.media_type==="movie"?"Movie":"TV Show",L=document.createElement("li");L.innerHTML=`
                        <img src="${H}" alt="${x}">
                        <div class="search-info">
                            <p>${x}</p>
                            <small>${F} | ${O}</small>
                        </div>`,L.addEventListener("click",()=>{window.location.href=`/p/details.html?id=${E.id}&type=${E.media_type}`}),_.appendChild(L)}),_.style.display="block"};var q=s;async function R(a){let v=`https://api.themoviedb.org/3/search/multi?api_key=${P}&query=${encodeURIComponent(a)}&language=en-US`;try{return(await(await fetch(v)).json()).results||[]}catch{return[]}}let l;D.addEventListener("input",()=>{let a=D.value.trim();clearTimeout(l),l=setTimeout(async()=>{if(a.length>=2){let v=await R(a);s(v)}else _.style.display="none"},300)}),document.addEventListener("click",a=>{a.target.closest(".search-container")||(_.style.display="none")})}let z=document.getElementById("library");if(z){let S=function(){let B=new Date().getFullYear();for(let k=B;k>=1950;k--)O.innerHTML+=`<option value="${k}">${k}</option>`;F.innerHTML+=Object.entries(J).map(([k,c])=>`<option value="${k}">${c}</option>`).join(""),[x,H,O,F,L,I].forEach(k=>{k.addEventListener("change",()=>{R=1,T(!0)})})},T=function(B=!1){if(l)return;l=!0,B&&(E.innerHTML="");let k=x.value,c=O.value,d=F.value,m=L.value,p=v.value.trim(),f=I.value,i=p.length>=2,$=i?`https://api.themoviedb.org/3/search/${k}?api_key=${P}&language=en-US&query=${encodeURIComponent(p)}&page=${R}`:`https://api.themoviedb.org/3/discover/${k}?api_key=${P}&language=en-US&sort_by=popularity.desc&page=${R}`;f&&($+=`&vote_average.gte=${f}`),i||(c&&($+=`&primary_release_year=${c}`),d&&($+=`&with_genres=${d}`),m&&($+=`&with_origin_country=${m}`)),fetch($).then(y=>y.json()).then(y=>{if(!y.results||y.results.length===0){R===1&&(E.innerHTML="<p>No results found.</p>"),l=!1;return}s=y.total_pages;let N=y.results.map((h,o)=>{let n=h.title||h.name||"Untitled",g=(h.release_date||h.first_air_date||"").split("-")[0]||"N/A",u=h.vote_average?h.vote_average.toFixed(1):"N/A",b=(h.genre_ids||[]).map(t=>J[t]).filter(Boolean).join(", ")||"N/A",j=h.overview?h.overview.slice(0,160)+"\u2026":"No overview available.",C=(R-1)*20+o+1;return`
                        <div class="movie-card" data-id="${h.id}" data-type="${k}">
                            <div class="movie-thumbnail">
                              <img src="${h.poster_path?`https://image.tmdb.org/t/p/w300${h.poster_path}`:"https://i.imgur.com/YyHsyEr.png"}" alt="${n}">
                              <div class="movie-rank rank-${C<=10?C:"default"}">${C}</div>
                            </div>
                            <div class="movie-info">
                              <div>
                                <div class="movie-title">${n}</div>
                                <div class="movie-meta">${k.charAt(0).toUpperCase()+k.slice(1)} \u2022 ${u} \u2022 ${g}</div>
                                <div class="movie-genres"><span>${b}</span></div>
                                <div class="movie-overview">${j}</div>
                              </div>
                              <div class="movie-actions">
                               <button class="play-button" onclick="window.location.href='/p/details.html?id=${h.id}&type=${k}'">
                                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path d="M18.89 12.85c-.35 1.34-2.02 2.29-5.36 4.19-3.23 1.84-4.84 2.76-6.14 2.42a4.3 4.3 0 0 1-1.42-.84C5 17.61 5 15.74 5 12s0-5.61.97-6.58c.4-.4.9-.69 1.43-.83 1.3-.37 2.91.55 6.14 2.4 3.34 1.9 5.01 2.85 5.36 4.19.15.55.15 1.14 0 1.67Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
                                  Play
                                </button>
                              </div>
                            </div>
                          </div>`}).join("");E.insertAdjacentHTML("beforeend",N),l=!1}).catch(y=>{E.innerHTML="<p>Error loading content.</p>",console.error(y),l=!1})},Z=function(){l||R>=s||window.scrollY+window.innerHeight>=document.body.offsetHeight-400&&(R++,T())};var G=S,ee=T,Q=Z;let R=1,s=1,l=!1,a,v=document.getElementById("search-bar"),E=document.getElementById("library-content"),x=document.getElementById("type-filter"),H=document.getElementById("status-filter"),O=document.getElementById("year-filter"),F=document.getElementById("genre-filter"),L=document.getElementById("country-filter"),I=document.getElementById("rating-filter");S(),T(!0),window.addEventListener("scroll",Z),v.addEventListener("input",()=>{clearTimeout(a),a=setTimeout(()=>{R=1,T(!0)},400)})}M().then(()=>{z&&initializeLibrary(P)})}function K(){let P=0,J=50,M=setInterval(()=>{window.apiKey?(clearInterval(M),Y(window.apiKey)):P++>=J&&(clearInterval(M),console.error("API Key (window.apiKey) was not found. Search/Library will not function."))},100)}K()});document.addEventListener("DOMContentLoaded",()=>{document.addEventListener("click",function(s){if(s.target.classList.contains("scroll-btn")||s.target.classList.contains("cast-scroll-btn")||s.target.classList.contains("tmdb-scroll")){let a=s.target.closest(".cast-scroll-wrapper, .tmdb-wrapper")?.querySelector(".cast-scroll, .tmdb-row");if(a){let v=s.target.classList.contains("left")?-1:1,E=a.clientWidth;a.scrollBy({left:v*E,behavior:"smooth"})}}});let Y;function K(){if(document.getElementById("custom-toast-notification"))return;let s=document.createElement("div");s.id="custom-toast-notification",document.body.appendChild(s)}function P(s,l="info"){let a=document.getElementById("custom-toast-notification");a&&(clearTimeout(Y),a.textContent=s,a.className="toast-show "+l,Y=setTimeout(()=>{a.className=a.className.replace("toast-show","")},3e3))}function J(){let s=document.getElementById("bookmark-count");if(s){let l=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");s.textContent=l.length,s.style.display=l.length>0?"flex":"none"}}function M(){let s=document.getElementById("bookmark-list");if(!s)return;let l=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");s.innerHTML=l.length===0?"<li>Your watchlist is empty.</li>":l.map((a,v)=>`
      <li class="bookmark-item">
        <a href="${a.url}" class="bookmark-link">
          <img src="${a.poster||"https://i.imgur.com/YyHsyEr.png"}" alt="${a.title}" class="bookmark-thumb">
          <span class="bookmark-title">${a.title}</span>
        </a>
        <button class="delete-bookmark" data-index="${v}" title="Remove">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7.84254 5.48939L8.52333 5.80406L7.84254 5.48939ZM8.81802 4.18112L8.31749 3.62258L8.31749 3.62258L8.81802 4.18112ZM10.2779 3.30696L10.5389 4.01009L10.2779 3.30696ZM13.7221 3.30696L13.9831 2.60384V2.60384L13.7221 3.30696ZM16.1575 5.48939L16.8383 5.17471L16.1575 5.48939ZM8.25 7.03259C8.25 6.61367 8.34194 6.19649 8.52333 5.80406L7.16175 5.17471C6.89085 5.76079 6.75 6.39238 6.75 7.03259H8.25ZM8.52333 5.80406C8.70487 5.41133 8.97357 5.04881 9.31855 4.73966L8.31749 3.62258C7.82675 4.06235 7.43251 4.58893 7.16175 5.17471L8.52333 5.80406ZM9.31855 4.73966C9.66369 4.43037 10.0778 4.18126 10.5389 4.01009L10.0169 2.60384C9.38616 2.83798 8.80808 3.18295 8.31749 3.62258L9.31855 4.73966ZM10.5389 4.01009C11.0001 3.8389 11.4968 3.75 12 3.75V2.25C11.3213 2.25 10.6477 2.36972 10.0169 2.60384L10.5389 4.01009ZM12 3.75C12.5032 3.75 12.9999 3.8389 13.4611 4.01009L13.9831 2.60384C13.3523 2.36972 12.6787 2.25 12 2.25V3.75ZM13.4611 4.01009C13.9222 4.18126 14.3363 4.43037 14.6815 4.73966L15.6825 3.62258C15.1919 3.18295 14.6138 2.83798 13.9831 2.60384L13.4611 4.01009ZM14.6815 4.73966C15.0264 5.04881 15.2951 5.41133 15.4767 5.80406L16.8383 5.17471C16.5675 4.58893 16.1733 4.06235 15.6825 3.62258L14.6815 4.73966ZM15.4767 5.80406C15.6581 6.19649 15.75 6.61367 15.75 7.03259H17.25C17.25 6.39238 17.1092 5.7608 16.8383 5.17471L15.4767 5.80406Z" fill="var(--keycolor)"></path><path d="M3 6.28259C2.58579 6.28259 2.25 6.61838 2.25 7.03259C2.25 7.44681 2.58579 7.78259 3 7.78259V6.28259ZM21 7.78259C21.4142 7.78259 21.75 7.44681 21.75 7.03259C21.75 6.61838 21.4142 6.28259 21 6.28259V7.78259ZM5 7.03259V6.28259H4.25V7.03259H5ZM19 7.03259H19.75V6.28259H19V7.03259ZM18.3418 16.8303L19.0624 17.0383L18.3418 16.8303ZM13.724 20.8553L13.8489 21.5949L13.724 20.8553ZM10.276 20.8553L10.401 20.1158L10.401 20.1158L10.276 20.8553ZM10.1183 20.8287L9.9933 21.5682L9.9933 21.5682L10.1183 20.8287ZM5.65815 16.8303L4.93757 17.0383L5.65815 16.8303ZM13.8817 20.8287L13.7568 20.0892L13.8817 20.8287ZM3 7.78259H21V6.28259H3V7.78259ZM13.7568 20.0892L13.599 20.1158L13.8489 21.5949L14.0067 21.5682L13.7568 20.0892ZM10.401 20.1158L10.2432 20.0892L9.9933 21.5682L10.151 21.5949L10.401 20.1158ZM18.25 7.03259V12.1758H19.75V7.03259H18.25ZM5.75 12.1759V7.03259H4.25V12.1759H5.75ZM18.25 12.1758C18.25 13.6806 18.0383 15.1776 17.6212 16.6223L19.0624 17.0383C19.5185 15.4583 19.75 13.8212 19.75 12.1758H18.25ZM13.599 20.1158C12.5404 20.2947 11.4596 20.2947 10.401 20.1158L10.151 21.5949C11.3751 21.8017 12.6248 21.8017 13.8489 21.5949L13.599 20.1158ZM10.2432 20.0892C8.40523 19.7786 6.90157 18.4335 6.37873 16.6223L4.93757 17.0383C5.61878 19.3981 7.58166 21.1607 9.9933 21.5682L10.2432 20.0892ZM6.37873 16.6223C5.9617 15.1776 5.75 13.6806 5.75 12.1759H4.25C4.25 13.8212 4.48148 15.4583 4.93757 17.0383L6.37873 16.6223ZM14.0067 21.5682C16.4183 21.1607 18.3812 19.3981 19.0624 17.0383L17.6212 16.6223C17.0984 18.4335 15.5947 19.7786 13.7568 20.0892L14.0067 21.5682ZM5 7.78259H19V6.28259H5V7.78259Z" fill="#6c6e76"></path><path d="M10 12V16M14 12V16" stroke="var(--keycolor)" stroke-width="1.5" stroke-linecap="round"></path></g></svg>
        </button>
      </li>`).join("")}let D=document.querySelector(".bookmark-btn"),_=document.getElementById("bookmark-modal");D&&_&&(D.addEventListener("click",s=>{s.preventDefault();let l=_.style.display==="block";_.style.display=l?"none":"block",l||M()}),document.addEventListener("click",s=>{_.style.display==="block"&&!_.contains(s.target)&&!D.contains(s.target)&&(_.style.display="none")}),_.addEventListener("click",s=>{let l=s.target.closest(".delete-bookmark");if(l){s.stopPropagation();let a=parseInt(l.getAttribute("data-index")),v=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");v.splice(a,1),localStorage.setItem("abefilm_bookmarks",JSON.stringify(v)),M(),J()}}));function z(s){let l=s.querySelector(".cast-scroll, .tmdb-row"),a=s.querySelector(".scroll-btn.left, .cast-scroll-btn.left, .tmdb-scroll.left"),v=s.querySelector(".scroll-btn.right, .cast-scroll-btn.right, .tmdb-scroll.right");if(!l||!a||!v)return;new ResizeObserver(()=>{if(!(l.scrollWidth>l.clientWidth+5)){a.style.display="none",v.style.display="none";return}let H=()=>{let O=Math.ceil(l.scrollLeft),F=l.scrollWidth-l.clientWidth;a.style.display=O>1?"flex":"none",v.style.display=O<F-1?"flex":"none"};l.addEventListener("scroll",H,{passive:!0}),H()}).observe(l)}function q(s){function l(L,I){let S="https://api.themoviedb.org/3/",T=new URL(S+L);return T.searchParams.set("api_key",I),T.searchParams.set("language","en-US"),T.toString()}function a(L,I){return L.media_type&&(L.media_type==="movie"||L.media_type==="tv")?L.media_type:I.startsWith("tv/")||I.startsWith("discover/tv")||I.startsWith("trending/tv")?"tv":"movie"}async function v(L,I){let S=document.getElementById("tmdb-slider"),T=document.getElementById("slider-dots"),Z=document.getElementById("slider-title");if(!S||!T||!Z)return;S.innerHTML="",T.innerHTML="";function B(m,p){return`https://api.themoviedb.org/3/${m}?api_key=${p}&language=en-US`}function k(m,p){return m.media_type||(p.includes("tv")?"tv":"movie")}try{let u=function(e){n=e,h.forEach((r,w)=>r.style.display=w===e?"block":"none"),o.forEach((r,w)=>r.classList.toggle("active",w===e)),Z.textContent=N[e]||"",g&&clearInterval(g),g=setInterval(()=>b(1),5e3)},b=function(e){let r=(n+e+h.length)%h.length;u(r)};var c=u,d=b;let m=B(L,I),i=((await(await fetch(m)).json()).results||[]).slice(0,8);if(i.length===0){S.innerHTML="<p>No slider content found.</p>";return}let $=i.map(e=>{let r=k(e,L),w=B(`${r}/${e.id}/images`,I)+"&include_image_language=en,null";return fetch(w).then(A=>A.json())}),y=await Promise.all($),N=[];i.forEach((e,r)=>{let w=k(e,L),A=e.title||e.name||"Untitled",W=e.backdrop_path;if(!W)return;let U=y[r],ie=U.logos?.find(V=>V.iso_639_1==="en")||U.logos?.[0],ae=ie?`https://image.tmdb.org/t/p/w300${ie.file_path}`:"",te=`${window.location.origin}/p/details.html?id=${e.id}&type=${w}`,ne=document.createElement("a");ne.className="slide",ne.href=te,ne.style.backgroundImage=`url(https://image.tmdb.org/t/p/original${W})`,ne.innerHTML=`<div class="slide-caption">${ae?`<img class="logo-title" src="${ae}" alt="${A} Logo">`:`<h2>${A}</h2>`}</div>`,S.appendChild(ne),N.push(A);let oe=document.createElement("div");oe.className="thumbnail-dot",oe.setAttribute("data-index",r),oe.style.backgroundImage=`url(https://image.tmdb.org/t/p/w300${W})`,T.appendChild(oe)});let h=S.querySelectorAll(".slide"),o=T.querySelectorAll(".thumbnail-dot"),n=0,g;o.forEach((e,r)=>{e.addEventListener("click",()=>u(r))});let j=document.querySelector(".slider-arrow.left"),C=document.querySelector(".slider-arrow.right");j&&(j.onclick=()=>b(-1)),C&&(C.onclick=()=>b(1)),h.length>0&&u(0);let t=0;S.addEventListener("touchstart",e=>{t=e.changedTouches[0].screenX},{passive:!0}),S.addEventListener("touchend",e=>{let r=e.changedTouches[0].screenX;r<t-50&&b(1),r>t+50&&b(-1)},{passive:!0})}catch(m){console.error("Failed to load slider content:",m),S&&(S.innerHTML="<p style='color:red;'>Error loading slider.</p>")}}function E(L,I){document.querySelectorAll(".widget-content").forEach(S=>{let T=S.closest(".widget");if(!T||["HTML01","Text1","Text2"].includes(T.id))return;let Z=S.textContent.trim();if(!Z||Z.includes(" ")||Z.startsWith("http"))return;let B=document.createElement("div");B.className="tmdb-wrapper";let k=document.createElement("div");k.className="tmdb-row",k.innerHTML=[...Array(7)].map(()=>`<div class="tmdb-card shimmer-card"><div class="tmdb-thumb shimmer"><img src="${I}" class="tmdb-logo" alt="Logo" /></div><div class="tmdb-title shimmer"></div></div>`).join(""),B.appendChild(k),S.insertAdjacentElement("afterend",B),new IntersectionObserver(async(d,m)=>{for(let p of d)if(p.isIntersecting){m.unobserve(p.target);try{let f=new Promise(g=>setTimeout(g,500)),i=l(Z,L),$=fetch(i).then(g=>g.json()),[y,N]=await Promise.all([f,$]),h=N.results||[];if(h.length===0){k.innerHTML="<p>No results found.</p>";return}k.innerHTML=h.slice(0,14).map(g=>{let u=a(g,Z),b=g.title||g.name||"Untitled",j=g.poster_path;if(!j)return"";let C=(g.release_date||g.first_air_date||"").split("-")[0]||"N/A",t=g.vote_average?.toFixed(1)||"N/A",e=`${window.location.origin}/p/details.html?id=${g.id}&type=${u}`;return`<a class="tmdb-card" title="${b}" href="${e}"><div class="tmdb-thumb"><img src="https://image.tmdb.org/t/p/w300${j}" alt="${b}" loading="lazy" /><div class="hover-overlay"></div><span class="tmdb-meta tmdb-year">${C}</span><span class="tmdb-meta tmdb-rating"><i class="bi bi-star"></i> ${t}</span><div class="play-btn"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="var(--keycolor)"/><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"/></svg></div></div><div class="tmdb-title">${b}</div></a>`}).join("");let o=document.createElement("button");o.className="tmdb-scroll left",o.innerHTML="&#8249;";let n=document.createElement("button");n.className="tmdb-scroll right",n.innerHTML="&#8250;",B.prepend(o),B.append(n),z(B)}catch(f){k.innerHTML="<p style='color:red;'>Failed to load data.</p>",console.error(f)}}},{threshold:.1,rootMargin:"150px 0px"}).observe(B)})}let x=document.querySelector("#Text1 .widget-content"),O=document.querySelector("#Text2 .widget-content")?.textContent.trim()||"",F=x?.textContent.trim();F&&v(F,apiKey),E(apiKey,O)}function G(s){let a=document.querySelector("#Text1 .widget-content")?.textContent.trim()||"https://api.themoviedb.org/3",v="https://image.tmdb.org/t/p/w500",E=new URLSearchParams(window.location.search),x=E.get("id"),H=E.get("type")||"movie",O=document.getElementById("movie-details-container"),F=1;async function L(){if(!x||!H){O.innerHTML="<p>Missing ID or type.</p>";return}try{let[c,d,m]=await Promise.all([fetch(`${a}/${H}/${x}?api_key=${s}&language=en-US`),fetch(`${a}/${H}/${x}/credits?api_key=${s}&language=en-US`),fetch(`${a}/${H}/${x}/${H==="movie"?"release_dates":"content_ratings"}?api_key=${s}`)]),p=await c.json(),f=await d.json(),i=await m.json(),$=I(H,i);S(p,f,$),H==="tv"?T(p.seasons):B(x),await k();let y=document.getElementById("cast-list");if(y&&f.cast?.length>0){let h=f.cast.slice(0,15).map(n=>`<div class="cast-card"><img src="${n.profile_path?v+n.profile_path:"https://i.imgur.com/obaaZjk.png"}" alt="${n.name}"><div>${n.name}</div><small>${n.character}</small></div>`).join(""),o=document.createElement("div");o.className="cast-scroll-wrapper",o.innerHTML=`<button class="scroll-btn left" aria-label="Scroll Left">\u2039</button><div class="cast-scroll">${h}</div><button class="scroll-btn right" aria-label="Scroll Right">\u203A</button>`,y.replaceWith(o),z(o)}let N=document.getElementById("user-reviews");try{let o=await(await fetch(`${a}/${H}/${x}/reviews?api_key=${s}&language=en-US`)).json();N&&(o.results&&o.results.length>0?N.innerHTML=o.results.slice(0,5).map(n=>{let g=n.author||"Anonymous",u=n.author_details?.avatar_path,b=u?u.startsWith("/https")?u.slice(1):`https://image.tmdb.org/t/p/w45${u}`:"https://ui-avatars.com/api/?name="+encodeURIComponent(g),j=new Date(n.created_at).toLocaleDateString();return`<div class="user-review"><div class="review-header"><img class="review-avatar" src="${b}" alt="${g}'s profile"><div><strong>${g}</strong><br><small>${j}</small></div></div><p class="review-content">${n.content.length>300?n.content.substring(0,300)+"...":n.content}</p></div>`}).join(""):N.innerHTML="<p>No user reviews available.</p>")}catch{N&&(N.innerHTML="<p>Failed to load user reviews.</p>")}}catch{O.innerHTML="<p>Error fetching details.</p>"}}function I(c,d){return c==="movie"?d.results?.find(p=>p.iso_3166_1==="US")?.release_dates?.[0]?.certification||"NR":d.results?.find(p=>p.iso_3166_1==="US")?.rating||"NR"}function S(c,d,m){let p=c.title||c.name,f=(c.release_date||c.first_air_date||"").split("-")[0]||"Unknown",i=c.genres?.map(u=>u.name).join("<span>|</span>")||"Unknown",$=c.vote_average?.toFixed(1)||"N/A",y=c.vote_count?.toLocaleString()||"0",N=c.overview||"No synopsis available.",h=c.poster_path?`${v}${c.poster_path}`:"https://i.imgur.com/YyHsyEr.png",o=c.backdrop_path?`https://image.tmdb.org/t/p/original${c.backdrop_path}`:"",n=c.origin_country?.[0]||c.production_countries?.[0]?.name||"Unknown",g=H==="tv"?"TV":"Movie";O.innerHTML=`<div class="detail-wrap"><div class="info-rating-wrapper"><div class="poster" style="--backdrop-url: url('${o}')"><img id="details-poster-img" data-main-poster="${h}" src="${h}" alt="${p}" /><div class="poster-play-btn" data-id="${x}" data-type="${H}" ${H==="tv"?'data-season="1"':""}><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="transparent"></path><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"></path></svg></div></div><div id="trailer-modal"><div id="modal-trailer-container"></div><div class="close-btn">&times;</div></div><div class="info"><h1 data-original-title="${p}">${p}</h1><div class="meta">${g} <span>|</span> ${f} <span>|</span> ${m} <span>|</span> ${n} <span>|</span> ${i}</div><p class="tagline">${N}</p><div class="buttons"><button class="watch" onclick="goToPlayer()"><i class="bi bi-play-fill"></i> Watch Now</button><button class="bookmark" onclick="bookmarkItem()"><i class="bi bi-bookmark"></i> Add to Watchlist</button><button class="share"><i class="bi bi-box-arrow-up-right"></i> Share</button></div></div><div class="rating"><i class="bi bi-star-fill"></i><strong>${$}</strong><span>/10</span><div class="vote-count">(${y} people rated)</div></div></div></div><div class="episode-placeholder" id="section-episodes"><h3>Episodes</h3><div class="episode-wrapper"><div id="season-buttons" class="season-wrap"></div><div id="episode-buttons" class="episode-wrap"></div></div></div><div class="details-extra-section"><div class="left-column"><div class="top-cast" id="section-cast"><h3>Top Cast</h3><div id="cast-list" class="cast-scroll"></div></div><div class="user-reviews"><h3>User Reviews</h3><div id="user-reviews" id="section-reviews"></div></div></div><div class="right-column"><h3>More Like This</h3><div id="more-like-grid" class="more-like-grid"></div></div></div>`}async function T(c){let d=document.getElementById("season-buttons");if(!d)return;d.innerHTML="",(c||[]).filter(f=>f.season_number!==0).forEach(f=>{let i=document.createElement("button");i.className="ep-btn season-btn",i.dataset.seasonNumber=f.season_number,i.dataset.airDate=f.air_date||"",i.dataset.posterPath=f.poster_path||"",i.textContent=`S${f.season_number}`,i.onclick=()=>{document.querySelectorAll(".season-btn").forEach($=>$.classList.remove("active")),i.classList.add("active"),Z(i.dataset.seasonNumber,i.dataset.airDate,i.dataset.posterPath)},d.appendChild(i)});let p=d.querySelector(".season-btn");p&&p.click()}async function Z(c,d,m){F=c;let p=document.getElementById("episode-buttons"),f=document.querySelector(".info h1"),i=document.querySelector(".info .meta"),$=document.getElementById("details-poster-img"),y=document.querySelector(".poster-play-btn");if(y&&(y.dataset.season=c),f){let u=f.dataset.originalTitle||f.innerText.split(" S")[0];f.textContent=`${u} S${c}`}if(i&&d){let u=d.split("-")[0]||"N/A",b=i.innerHTML.split("<span>|</span>");b.length>1&&(b[1]=` ${u} `,i.innerHTML=b.join("<span>|</span>"))}$&&(m&&m!=="null"?$.src=`${v}${m}`:$.src=$.dataset.mainPoster);let h=await(await fetch(`${a}/tv/${x}/season/${c}?api_key=${s}&language=en-US`)).json(),n=window.innerWidth<=600?14:35,g=(u,b=!1)=>{if(!p)return;if(p.innerHTML="",((b||(u||[]).length<=n?u:(u||[]).slice(0,n))||[]).forEach(C=>{let t=document.createElement("a");t.className="btn episode-btn",t.textContent=String(C.episode_number).padStart(2,"0"),t.href=`/p/player.html?id=${x}&type=tv&season=${c}&ep=${C.episode_number}`,p.appendChild(t)}),(u||[]).length>n){let C=document.createElement("button");C.className=`btn episode-btn ${b?"hide-btn":"show-more"}`,C.textContent=b?"Hide":"More",C.onclick=()=>g(h.episodes,!b),p.appendChild(C)}};h.episodes&&g(h.episodes,!1)}async function B(c){let d=document.getElementById("season-buttons"),m=document.getElementById("episode-buttons");d.innerHTML="",m.innerHTML="";let f=await(await fetch(`${a}/movie/${c}?api_key=${s}&language=en-US`)).json();if(f.belongs_to_collection)((await(await fetch(`https://api.themoviedb.org/3/collection/${f.belongs_to_collection.id}?api_key=${s}`)).json()).parts||[]).sort((h,o)=>new Date(h.release_date)-new Date(o.release_date)).forEach((h,o)=>{let n=document.createElement("a");n.className="ep-btn season-btn"+(h.id==c?" active":""),n.textContent=`Part ${o+1}`,n.href=`${window.location.origin}/p/details.html?id=${h.id}&type=movie`,d.appendChild(n)});else{let $=document.createElement("button");$.className="ep-btn season-btn active",$.textContent="S1",d.appendChild($)}let i=document.createElement("a");i.className="btn episode-btn",i.textContent="01",i.href=`/p/player.html?id=${c}&type=movie`,m.appendChild(i)}async function k(){let c=document.getElementById("more-like-grid");c.innerHTML="";try{let m=await(await fetch(`${a}/${H}/${x}/recommendations?api_key=${s}&language=en-US`)).json();if(!m.results||m.results.length===0){c.innerHTML="<p>No recommendations available.</p>";return}m.results.slice(0,6).forEach(p=>{let f=document.createElement("a");f.href=`${window.location.origin}/p/details.html?id=${p.id}&type=${H}`,f.className="more-like-item abefilm-hover-card";let i=p.poster_path?`${v}${p.poster_path}`:"https://i.imgur.com/YyHsyEr.png";f.innerHTML=`<div class="abefilm-image-wrap"><img src="${i}" alt="${p.title||p.name}" onerror="this.src='https://i.imgur.com/YyHsyEr.png';"><div class="abefilm-hover-overlay"></div><div class="abefilm-play-button"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="var(--keycolor)"></path><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"></path></svg></div></div><p>${p.title||p.name}</p>`,c.appendChild(f)})}catch{c.innerHTML="<p>Failed to load recommendations.</p>"}}window.goToPlayer=function(){let c=new URLSearchParams(window.location.search),d=c.get("id"),m=c.get("type");if(d&&m){let p=m==="tv"?`/p/player.html?id=${d}&type=tv&season=${F}&ep=1`:`/p/player.html?id=${d}&type=movie`;window.location.href=p}},window.bookmarkItem=function(){let c=new URLSearchParams(window.location.search),d=c.get("id"),m=c.get("type")||"movie",p=document.querySelector(".info h1")?.innerText,f=document.querySelector(".poster img")?.src;if(!d||!m||!p){P("Cannot add to watchlist: missing info.","info");return}let i=JSON.parse(localStorage.getItem("abefilm_bookmarks")||"[]");if(i.some(y=>y.id===d&&y.type===m)){P("Already on your watchlist","info");return}let $=`/p/details.html?id=${d}&type=${m}`;i.push({id:d,type:m,title:p,poster:f,url:$}),localStorage.setItem("abefilm_bookmarks",JSON.stringify(i)),P("Added to Watchlist","success"),J()},document.addEventListener("click",async function(c){if(c.target.closest(".poster-play-btn")){let d=c.target.closest(".poster-play-btn"),m=d.getAttribute("data-id"),p=d.getAttribute("data-type"),f=d.getAttribute("data-season"),i=document.getElementById("modal-trailer-container"),$=document.getElementById("trailer-modal");try{let y;p==="tv"&&f?y=`${a}/tv/${m}/season/${f}/videos?api_key=${s}&language=en-US`:y=`${a}/${p}/${m}/videos?api_key=${s}&language=en-US`;let h=await(await fetch(y)).json(),o=h.results.find(n=>n.type==="Trailer"&&n.site==="YouTube")||h.results.find(n=>n.type==="Teaser"&&n.site==="YouTube");o?i.innerHTML=`<iframe src="https://www.youtube.com/embed/${o.key}?autoplay=1" allowfullscreen allow="autoplay; encrypted-media" frameborder="0"></iframe>`:i.innerHTML="<p>No trailer found for this season.</p>",$.classList.add("active")}catch{i.innerHTML="<p>Error loading trailer.</p>",$.classList.add("active")}}if(c.target.closest(".share")){let d=window.location.href,m=document.querySelector(".info h1")?.innerText||"Check this out!";navigator.share?navigator.share({title:m,text:"Watch this online:",url:d}):navigator.clipboard.writeText(d).then(()=>P("Link copied!","success"),()=>prompt("Copy link:",d))}if(c.target.classList.contains("close-btn")){let d=document.getElementById("trailer-modal");d&&d.classList.remove("active");let m=document.getElementById("modal-trailer-container");m&&(m.innerHTML="")}}),L()}function ee(s){let l=new URLSearchParams(window.location.search),a=l.get("id"),v=l.get("type");if(!a||!v){document.body.innerHTML="<p style='color:white; text-align:center;'>Missing ID or type in URL.</p>";return}let E=`watch_state_${a}_${v}`;function x(o,n,g){let u={server:o,season:n,episode:g};localStorage.setItem(E,JSON.stringify(u))}function H(){let o=localStorage.getItem(E);return o?JSON.parse(o):null}function O(o,n,g){fetch(`https://api.themoviedb.org/3/${n}/${o}?api_key=${s}&language=en-US`).then(u=>u.json()).then(u=>{let b=u.title||u.name||"Untitled",j=n==="tv"?` S${g}`:"";document.title=`${b}${j} - Watch Now | AbeFilm`}).catch(u=>console.error("Title update failed:",u))}let F=document.getElementById("video-left"),L=document.getElementById("player-episode-buttons"),I=document.getElementById("server-buttons"),S=document.createElement("div");S.id="season-buttons",S.classList.add("season-button-container"),I&&I.insertAdjacentElement("afterend",S);let T=H(),Z=T?.season,B=parseInt(l.get("season")||Z||"1"),k=parseInt(l.get("ep")||T?.episode||"1"),c=T?.episode||k,d=T?.server||null,m={};function p(){let o=document.getElementById("video-sources");if(!o)return;o.querySelectorAll(".widget").forEach(g=>{let u=g.querySelector(".widget-title, .title")?.textContent.trim().toLowerCase(),b=g.querySelector(".widget-content")?.textContent.trim();if(u&&b){let j=b.split(`
`).map(e=>e.trim()).filter(Boolean),C=null,t=null;for(let e of j)/\${episode}/.test(e)?t=e:/\${id}/.test(e)&&(C=e);m[u]={movie:e=>C?C.replace(/\$\{id\}/g,e):"",tv:(e,r,w)=>t?t.replace(/\$\{id\}/g,e).replace(/\$\{season\}/g,r).replace(/\$\{episode\}/g,w):""}}})}function f(o=1){c=o;let n=m[d];if(!n||!F)return;let g=v==="movie"?n.movie(a):n.tv(a,B,o);F.innerHTML=g?`<iframe src="${g}" frameborder="0" allowfullscreen loading="lazy" style="width:100%;height:100%;max-height:100vh;"></iframe>`:"<p style='color:white'>Invalid or missing source URL.</p>"}function i(){I&&Object.keys(m).forEach(o=>{let n=document.createElement("button");n.textContent=o.toUpperCase(),n.className="server-btn",d||(d=o),o===d&&n.classList.add("active"),n.addEventListener("click",()=>{document.querySelectorAll(".server-btn").forEach(g=>g.classList.remove("active")),n.classList.add("active"),d=o,x(d,B,c),f(c)}),I.appendChild(n)})}function $(o){if(!L)return;L.innerHTML="";for(let u=1;u<=o;u++){let b=document.createElement("button");b.textContent=`${u}`,b.className="player-episode-btn",b.addEventListener("click",()=>{document.querySelectorAll(".player-episode-btn").forEach(j=>j.classList.remove("active")),b.classList.add("active"),x(d,B,u),f(u)}),L.appendChild(b)}let n=L.querySelectorAll(".player-episode-btn"),g=n[k-1]||n[0];g&&g.classList.add("active"),f(k)}function y(){if(!L)return;L.innerHTML="";let o=document.createElement("button");o.textContent="1",o.className="player-episode-btn active",L.appendChild(o)}function N(o){let n=document.getElementById("footer-bottom");if(!n)return;let{title:g,name:u,overview:b,genres:j,status:C,vote_average:t,first_air_date:e,release_date:r,number_of_episodes:w}=o,A=w?"TV":"Movie",W=(r||e||"").split("-")[0];if(v==="tv"&&o?.seasons&&B){let V=o.seasons.find(X=>X.season_number==B);V?.air_date&&(W=V.air_date.split("-")[0])}let U=t?t.toFixed(1):"N/A",ie=j?.map(V=>V.name).join(", ")||"Unknown",ae=C||"Unknown",te=o.certification||o.content_ratings?.results?.find(V=>V.iso_3166_1==="US")?.rating||"NR";n.innerHTML=`<div class="footer-left"><div class="footer-title-rating"><strong>${g||u||"Untitled"}${w?` S${B}`:""} (${W})</strong></div><div class="footer-meta"><span class="footer-rating">\u2B50 ${U}</span><span class="type-meta">${A}</span> \u2022 <span>${ae}</span> \u2022 <span>Rated: ${te}</span></div><div class="footer-genres"><strong>Genres:</strong> ${ie}</div><div class="footer-overview">${b||"No overview available."}</div><span class="read-more-toggle">More</span></div><div class="footer-right"><h3>Recommended</h3><div class="recommendation-grid"></div></div>`;let ne=n.querySelector(".footer-overview"),oe=n.querySelector(".read-more-toggle");ne&&oe&&window.innerWidth<=768&&oe.addEventListener("click",()=>{ne.classList.toggle("expanded"),oe.textContent=ne.classList.contains("expanded")?"Less":"More"}),fetch(`https://api.themoviedb.org/3/${w?"tv":"movie"}/${o.id}/credits?api_key=${s}`).then(V=>V.json()).then(V=>{let X=V.cast?.slice(0,15);if(X?.length>0){let se=document.createElement("div");se.className="footer-cast-scroll-wrapper",se.innerHTML=`<h4>Cast</h4><div class="cast-scroll-wrapper"><button class="cast-scroll-btn left" aria-label="Scroll Left">\u2039</button><div class="cast-scroll">${X.map(re=>`<div class="cast-card"><img src="${re.profile_path?`https://image.tmdb.org/t/p/w185${re.profile_path}`:"https://i.imgur.com/obaaZjk.png"}" alt="${re.name}" onerror="this.onerror=null;this.src='https://i.imgur.com/obaaZjk.png';"><div class="cast-name">${re.name}</div><div class="cast-role">${re.character}</div></div>`).join("")}</div><button class="cast-scroll-btn right" aria-label="Scroll Right">\u203A</button></div>`,n.querySelector(".footer-left").appendChild(se),z(se.querySelector(".cast-scroll-wrapper"))}}).catch(V=>console.error("Cast Fetch Error:",V))}function h(o,n){let g=document.querySelector(".recommendation-grid");if(!g)return;let u=`https://api.themoviedb.org/3/${n}/${o}/recommendations?api_key=${s}`;fetch(u).then(b=>b.json()).then(b=>{let j=b.results?.slice(0,6);if(!j||j.length===0){g.innerHTML="<p style='color:#ccc'>No recommendations available.</p>";return}g.innerHTML=j.map(C=>{let t=C.title||C.name||"Untitled",e=C.poster_path?`https://image.tmdb.org/t/p/w185${C.poster_path}`:"https://i.imgur.com/YyHsyEr.png",r=C.media_type||(C.first_air_date?"tv":"movie");return`<div class="rec-item"><a href="/p/player.html?id=${C.id}&type=${r}"><div class="rec-thumb"><img src="${e}" alt="${t}" onerror="this.onerror=null;this.src='https://i.imgur.com/YyHsyEr.png';"><div class="abefilm-hover-overlay"></div><div class="abefilm-play-button"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="var(--keycolor)"/><path d="M15.4137 13.059L10.6935 15.8458C9.93371 16.2944 9 15.7105 9 14.7868V9.21316C9 8.28947 9.93371 7.70561 10.6935 8.15419L15.4137 10.941C16.1954 11.4026 16.1954 12.5974 15.4137 13.059Z" fill="#FFFFFF"/></svg></div></div><span>${t}</span></a></div>`}).join("")}).catch(b=>{console.error("Recommendation Fetch Error:",b),g.innerHTML="<p style='color:#ccc'>Failed to load recommendations.</p>"})}O(a,v,B),p(),Object.keys(m).length>0?(i(),f(c)):F&&(F.innerHTML="<p style='color:white'>No server templates found.</p>"),v==="tv"?(fetch(`https://api.themoviedb.org/3/tv/${a}?api_key=${s}`).then(o=>o.json()).then(o=>{N(o),h(o.id,v),o.seasons&&o.seasons.length>0&&S&&(S.innerHTML=o.seasons.filter(n=>n.season_number!==0).map(n=>`<a href="?id=${a}&type=tv&season=${n.season_number}" class="season-btn${n.season_number===B?" active":""}">${n.name}</a>`).join(""))}),fetch(`https://api.themoviedb.org/3/tv/${a}/season/${B}?api_key=${s}`).then(o=>o.json()).then(o=>{$(o.episodes?.length||0)})):v==="movie"&&(fetch(`https://api.themoviedb.org/3/movie/${a}?api_key=${s}`).then(o=>o.json()).then(o=>{N(o),h(o.id,v),o.belongs_to_collection?.id&&fetch(`https://api.themoviedb.org/3/collection/${o.belongs_to_collection.id}?api_key=${s}`).then(n=>n.json()).then(n=>{n.parts&&n.parts.length>1&&S&&(S.innerHTML=n.parts.sort((g,u)=>new Date(g.release_date)-new Date(u.release_date)).map((g,u)=>`<a href="?id=${g.id}&type=movie&part=${u+1}" class="season-btn${g.id==a?" active":""}">${"Part "+(u+1)}</a>`).join(""))})}),y(),f())}function Q(s){K(),J();let l=window.location.pathname,a=l.includes("/p/details.html"),v=l.includes("/p/player.html");a?G(s):v?ee(s):document.getElementById("tmdb-slider")&&q(s)}function R(){let s=0,l=50,a=setInterval(()=>{window.apiKey?(clearInterval(a),Q(window.apiKey)):s++>=l&&(clearInterval(a),console.error("FATAL: API Key (window.apiKey) was not found. App will not run."),[document.getElementById("tmdb-slider"),document.getElementById("movie-details-container"),document.getElementById("video-left")].forEach(E=>{E&&(E.innerHTML="<p style='color:red; text-align:center; padding: 2rem;'>Error: API configuration is missing.</p>")}))},100)}R()});document.addEventListener("DOMContentLoaded",function(){let Y=window.location.href,K=window.innerWidth<=768,P=location.origin+"/",J=location.pathname==="/"||location.pathname.endsWith("/index.html")||location.hostname.includes("blogspot.com")&&!location.pathname.includes("/p/"),M=Y.includes("/p/details.html"),D=Y.includes("/p/player.html"),_=Y.includes("/p/library.html"),z=Y.includes("/p/about-us.html"),q=Y.includes("/p/privacy-policy.html"),G=Y.includes("/p/disclaimer.html"),ee=document.querySelector("#Text12 .widget-content"),Q=document.querySelector("#Text13 .widget-content"),R=document.querySelector("#Text14 .widget-content"),s=document.querySelector("footer .website-name"),l=document.querySelector("footer .website-description"),a=document.querySelector("footer .credit");if(ee&&s&&(s.innerHTML=ee.innerHTML),Q&&l&&(l.innerHTML=Q.innerHTML),R&&a){a.innerHTML=R.innerHTML;let i=a.querySelector("#currentYear");i&&(i.textContent=new Date().getFullYear())}let v=document.getElementById("about-us"),E=document.getElementById("privacy-policy"),x=document.getElementById("disclaimer"),H=document.querySelector("#Text10 .widget-content"),O=document.querySelector("#Text9 .widget-content"),F=document.querySelector("#Text11 .widget-content");z&&v&&H&&(v.innerHTML=H.innerHTML),q&&E&&O&&(E.innerHTML=O.innerHTML),G&&x&&F&&(x.innerHTML=F.innerHTML);let L=document.getElementById("details-content"),I=document.getElementById("player-content"),S=document.getElementById("library");L&&(L.style.display=M?"block":"none"),I&&(I.style.display=D?"block":"none"),S&&(S.style.display=_?"block":"none"),v&&(v.style.display=z?"block":"none"),E&&(E.style.display=q?"block":"none"),x&&(x.style.display=G?"block":"none"),D&&(document.querySelector(".top-header")?.remove(),document.querySelector(".side-menu")?.remove()),_&&K&&document.querySelector(".top-header")?.remove();let T={home:"tmdb-section-1",movies:"tmdb-section-2",tvseries:"tmdb-section-3",animation:"tmdb-section-4",kdramas:"tmdb-section-5",cdramas:"tmdb-section-6",anime:"tmdb-section-7","western-movies":"tmdb-section-8","western-series":"tmdb-section-9"};if(document.querySelectorAll('.side-menu a[href^="#"], .bottom-navbar a[href^="#"], .anchor-links a[href^="#"]').forEach(i=>{i.addEventListener("click",function($){J||($.preventDefault(),window.location.href=P+this.getAttribute("href"))})}),!J&&location.hash&&T[location.hash.replace("#","")]){window.location.href=P+location.hash;return}if(J){let i=()=>{let $=window.location.hash.replace("#","")||"home";Object.entries(T).forEach(([y,N])=>{let h=document.getElementById(N);h&&(h.style.display=y===$?"block":"none")}),document.querySelectorAll(".side-menu a, .bottom-navbar a, .anchor-links a").forEach(y=>{let N=y.getAttribute("href")?.replace("#","");y.classList.toggle("active",N===$)})};i(),window.addEventListener("hashchange",i)}let Z;function B(i,$="info"){let y=document.getElementById("custom-toast-notification");y||(y=document.createElement("div"),y.id="custom-toast-notification",document.body.appendChild(y)),clearTimeout(Z),y.textContent=i,y.className="toast-show "+$,Z=setTimeout(()=>{y.className=y.className.replace("toast-show","")},3e3)}let k=document.querySelector(".top-header");if(k){let i=()=>{J&&!K?k.classList.toggle("scrolled",window.scrollY>100):K||k.classList.add("scrolled")};window.addEventListener("scroll",i),i()}let c=document.getElementById("toggleSidebar"),d=document.getElementById("mobileSidebar"),m=document.getElementById("sidebarOverlay");c&&d&&m&&(c.addEventListener("click",()=>{d.classList.toggle("active"),m.style.display=d.classList.contains("active")?"block":"none"}),m.addEventListener("click",()=>{d.classList.remove("active"),m.style.display="none"})),document.querySelector(".share-btn")?.addEventListener("click",()=>{navigator.share?navigator.share({title:document.title,url:window.location.href}).catch(i=>console.warn("Share failed:",i)):navigator.clipboard.writeText(window.location.href).then(()=>B("Link copied to clipboard!","success")).catch(()=>B("Could not copy link.","error"))}),document.querySelector(".top-btn")?.addEventListener("click",()=>{window.scrollTo({top:0,behavior:"smooth"})}),document.querySelector(".back-history")?.addEventListener("click",i=>{i.preventDefault(),window.history.length>1?window.history.back():window.location.href="/"});let p=document.getElementById("comment-nav-button"),f=document.getElementById("comment-section");p&&f&&p.addEventListener("click",i=>{i.preventDefault(),f.scrollIntoView({behavior:"smooth",block:"start"})})});document.addEventListener("DOMContentLoaded",()=>{if(!document.getElementById("comment-section"))return;let{createClient:K}=supabase,M=K("https://hwucnfgzeghfmagromyb.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh3dWNuZmd6ZWdoZm1hZ3JvbXliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2MzUwMjMsImV4cCI6MjA3MDIxMTAyM30.Sl8JjfFj9iEWZxwun9XzaZeQcEN1BtfcU2FmlGdemI8"),D=new URLSearchParams(window.location.search),_=D.get("id"),z=D.get("type"),q=_&&z?`${z}-${_}`:window.location.pathname,G=document.getElementById("authModal"),ee=document.getElementById("closeAuthModalBtn"),Q=document.getElementById("showAuthModalBtn"),R=document.getElementById("loginPrompt"),s=document.getElementById("commentFormContainer"),l=document.getElementById("message"),a=document.getElementById("submit"),v=document.getElementById("logoutBtn"),E=document.getElementById("avatarModal"),x=document.getElementById("closeAvatarModalBtn"),H=document.getElementById("currentUserAvatar"),O=document.getElementById("currentUsernameDisplay"),F=document.getElementById("saveAvatarBtn"),L=null,I="https://cdn-icons-png.flaticon.com/128/1046/1046929.png",S=!0,T=!1,Z={},B={person:["https://cdn-icons-png.flaticon.com/128/4139/4139981.png","https://cdn-icons-png.flaticon.com/128/4140/4140057.png","https://cdn-icons-png.flaticon.com/128/4140/4140077.png","https://cdn-icons-png.flaticon.com/128/2202/2202112.png","https://cdn-icons-png.flaticon.com/128/4140/4140061.png","https://cdn-icons-png.flaticon.com/128/4140/4140037.png","https://cdn-icons-png.flaticon.com/128/4140/4140051.png","https://cdn-icons-png.flaticon.com/128/4139/4139951.png","https://cdn-icons-png.flaticon.com/128/4140/4140060.png","https://cdn-icons-png.flaticon.com/128/6997/6997662.png","https://cdn-icons-png.flaticon.com/128/4140/4140040.png","https://cdn-icons-png.flaticon.com/128/4140/4140047.png"],animal:["https://cdn-icons-png.flaticon.com/128/4322/4322991.png","https://cdn-icons-png.flaticon.com/128/4775/4775614.png","https://cdn-icons-png.flaticon.com/128/4775/4775640.png","https://cdn-icons-png.flaticon.com/128/1326/1326390.png","https://cdn-icons-png.flaticon.com/128/9308/9308861.png","https://cdn-icons-png.flaticon.com/128/9308/9308872.png","https://cdn-icons-png.flaticon.com/128/1326/1326415.png","https://cdn-icons-png.flaticon.com/128/9308/9308930.png","https://cdn-icons-png.flaticon.com/128/1760/1760998.png","https://cdn-icons-png.flaticon.com/128/1326/1326401.png","https://cdn-icons-png.flaticon.com/128/4775/4775517.png","https://cdn-icons-png.flaticon.com/128/9308/9308916.png","https://cdn-icons-png.flaticon.com/128/3940/3940435.png","https://cdn-icons-png.flaticon.com/128/6740/6740990.png","https://cdn-icons-png.flaticon.com/128/4775/4775608.png","https://cdn-icons-png.flaticon.com/128/1005/1005364.png","https://cdn-icons-png.flaticon.com/128/6740/6740990.png","https://cdn-icons-png.flaticon.com/128/4775/4775608.png"],animation:["https://i.pinimg.com/1200x/f5/44/96/f544962a7b3129c0637ac2ae3822ce04.jpg","https://i.pinimg.com/1200x/17/86/c4/1786c496eb64a64f81181de49638d713.jpg","https://i.pinimg.com/736x/6d/d0/73/6dd073b2fa2e8e85b3667f76a233300c.jpg","https://i.pinimg.com/736x/0b/41/df/0b41dff69b51c42493489ed10eada7ee.jpg","https://i.pinimg.com/1200x/57/c4/ac/57c4acf284c8278a97dd862b90d0a7f6.jpg","https://i.pinimg.com/736x/8b/38/fe/8b38fe784ebdef337b2e5925e849b865.jpg","https://i.pinimg.com/736x/f7/2c/d1/f72cd11d081fda86f6defac97834fa6a.jpg","https://i.pinimg.com/736x/22/dc/88/22dc88835f11c148a26724be02ba37d6.jpg","https://i.pinimg.com/736x/08/97/a3/0897a36b7d6da0a57ee8a1fed7f67bbc.jpg","https://i.pinimg.com/736x/4f/50/5b/4f505b0e22c2fb9de8df11606d63aee3.jpg","https://i.pinimg.com/1200x/cf/40/37/cf40375b3ad057d3b6759fd7b5cfc69b.jpg","https://i.pinimg.com/736x/21/da/6a/21da6af1a11272715f67c3d5ccac4941.jpg","https://i.pinimg.com/736x/71/d8/00/71d8003e7580495d0bafd80eccd3b3c0.jpg","https://i.pinimg.com/736x/be/38/78/be3878c34f93d1663a6e5f6af4b78e9c.jpg","https://i.pinimg.com/736x/33/3d/d0/333dd06be42713804de17ae38caa0680.jpg","https://i.pinimg.com/1200x/dc/89/44/dc8944d0b4f1174080edb5bb66e97eaf.jpg","https://i.pinimg.com/736x/a7/6e/32/a76e3272f50feb992792ee874910d233.jpg","https://i.pinimg.com/1200x/77/70/3f/77703fafc70fcf5e37089acd53fd514a.jpg"],emoji:["https://i.pinimg.com/736x/5b/8b/26/5b8b26358e27e259ca5b308adb0007d9.jpg","https://i.pinimg.com/1200x/4e/ed/e3/4eede304ca4f6bfcc857e9343c33fc95.jpg","https://i.pinimg.com/1200x/15/e8/32/15e832be938d0e6ed7266bf789d71bb7.jpg","https://i.pinimg.com/1200x/87/a6/a3/87a6a35d663a034c38bdf8b7be022acd.jpg","https://i.pinimg.com/1200x/43/27/bd/4327bd2cf07e8311bcf05fce38aedc9a.jpg","https://i.pinimg.com/1200x/08/16/61/081661bd0bf7ec4b45d4fc3dd820a60f.jpg","https://i.pinimg.com/1200x/23/c0/06/23c00684fe980429026b8d012e64f25c.jpg","https://i.pinimg.com/1200x/2a/34/06/2a3406c7a142f9173536f3f7d744edc5.jpg","https://i.pinimg.com/736x/9e/f1/84/9ef1846a74700af02e30898ff0e4b730.jpg","https://i.pinimg.com/736x/8b/43/0a/8b430af942a8482b1b817a38725adc18.jpg","https://i.pinimg.com/736x/53/ea/b3/53eab3d0b5babe47d2808e8353176127.jpg","https://i.pinimg.com/1200x/b1/7f/b5/b17fb561e2092833380731bc6553fa1f.jpg","https://i.pinimg.com/736x/ff/67/8e/ff678e727c07cd355797551d5f468f89.jpg","https://i.pinimg.com/736x/2e/f4/33/2ef433ecf11c3c52d21c83e0a8a05f2c.jpg","https://i.pinimg.com/736x/ea/98/95/ea989550c5533f9682859bd79fc6be01.jpg","https://i.pinimg.com/1200x/0e/68/de/0e68de2be0c8f1ddd5fe87aa3ca304d7.jpg","https://i.pinimg.com/1200x/6c/a9/4b/6ca94b596e161af20fe4738eadf18eef.jpg","https://i.pinimg.com/1200x/ca/f2/ee/caf2ee640db02286ed2c3617178ec958.jpg"]};async function k(){if(!q||q===window.location.pathname)return;let{data:t,error:e}=await M.from("reactions").select("*").eq("topic",q).single();if(e&&e.code==="PGRST116"){let{data:r,error:w}=await M.from("reactions").insert({topic:q,upvote:0,funny:0,love:0,surprised:0,angry:0,sad:0}).select().single();if(w){console.error("Error creating reaction entry:",w);return}t=r}else if(e){console.error("Error fetching reactions:",e);return}Z=t,c()}function c(){if(!Z)return;let t=0;Object.keys(Z).forEach(r=>{if(["topic","id","created_at"].includes(r))return;let w=Z[r]||0,A=document.getElementById(`${r}-count`);A&&(A.textContent=w,t+=w)}),document.getElementById("totalResponses").textContent=t;let e=localStorage.getItem(q);document.querySelectorAll(".reaction").forEach(r=>{r.classList.toggle("reacted",r.dataset.reaction===e)})}async function d(t){if(T||!q)return;T=!0;let e=localStorage.getItem(q),r;e===t?(localStorage.removeItem(q),r=M.rpc("decrement_reaction",{topic_name:q,reaction_name:t})):e?(localStorage.setItem(q,t),r=M.rpc("switch_reaction",{topic_name:q,old_reaction_name:e,new_reaction_name:t})):(localStorage.setItem(q,t),r=M.rpc("increment_reaction",{topic_name:q,reaction_name:t}));let{error:w}=await r;w&&(console.error("Failed to update reaction:",w),e?localStorage.setItem(q,e):localStorage.removeItem(q)),await k(),T=!1}async function m(t){if(L=t?.user||null,L){R.style.display="none",s.style.display="block";let e=L.user_metadata?.username||(L.is_anonymous?"Guest User":L.email);O.textContent=e,I=L.user_metadata?.profile_url||"https://cdn-icons-png.flaticon.com/128/1046/1046929.png",H.src=I}else R.style.display="block",s.style.display="none";j()}M.auth.onAuthStateChange((t,e)=>{m(e)}),document.getElementById("signInBtn").addEventListener("click",async()=>{let t=document.getElementById("loginEmail").value,e=document.getElementById("loginPassword").value,{error:r}=await M.auth.signInWithPassword({email:t,password:e});r?alert(r.message):G.style.display="none"}),document.getElementById("signUpBtn").addEventListener("click",async()=>{let t=document.getElementById("signupEmail").value,e=document.getElementById("signupPassword").value,r=document.getElementById("signupUsername").value.trim();if(!r)return alert("Please enter a display name for signup.");let{data:w,error:A}=await M.auth.signUp({email:t,password:e,options:{data:{username:r,profile_url:"https://cdn-icons-png.flaticon.com/128/1046/1046929.png"}}});A?alert(A.message):w.user&&(alert("Signed up successfully! Please check your email to confirm your account."),G.style.display="none")}),document.getElementById("guestSignInBtn").addEventListener("click",async()=>{let{data:t,error:e}=await M.auth.signInAnonymously();e?(console.error("GUEST SIGN-IN FAILED:",e),alert(e.message)):G.style.display="none"}),v.addEventListener("click",async()=>{let{error:t}=await M.auth.signOut();t&&alert(t.message)});function p(){G.style.display=G.style.display==="block"?"none":"block",i("login")}function f(){E.style.display=E.style.display==="block"?"none":"block",document.querySelectorAll("#avatarModal .tab-content img").forEach(e=>e.classList.remove("selected"));let t=document.querySelector(`#avatarModal img[src="${I}"]`);t&&t.classList.add("selected")}function i(t){document.querySelectorAll("#authModal .tab-content").forEach(e=>e.classList.remove("active")),document.getElementById(t).classList.add("active"),document.querySelectorAll("#authModal .tab-btn").forEach(e=>e.classList.remove("active")),document.querySelector(`#authModal .tab-btn[data-tab="${t}"]`).classList.add("active")}function $(t){document.querySelectorAll("#avatarModal .tab-content").forEach(r=>r.classList.remove("active")),document.getElementById(t).classList.add("active"),document.querySelectorAll("#avatarModal .tab-btn").forEach(r=>r.classList.remove("active")),document.querySelector(`#avatarModal .tab-btn[data-tab="${t}"]`).classList.add("active")}Q.addEventListener("click",p),ee.addEventListener("click",p),x.addEventListener("click",f),H.addEventListener("click",f),document.querySelectorAll("#authModal .tab-btn").forEach(t=>t.addEventListener("click",()=>i(t.dataset.tab))),document.querySelectorAll("#avatarModal .tab-btn").forEach(t=>t.addEventListener("click",()=>$(t.dataset.tab)));function y(){Object.entries(B).forEach(([t,e])=>{let r=document.getElementById(t);r&&(r.innerHTML="",e.forEach(w=>{let A=document.createElement("img");A.src=w,A.addEventListener("click",()=>{document.querySelectorAll("#avatarModal .tab-content img").forEach(W=>W.classList.remove("selected")),A.classList.add("selected"),I=w}),r.appendChild(A)}))})}F.addEventListener("click",async()=>{if(!L)return alert("You must be logged in to save an avatar.");let{data:t,error:e}=await M.auth.updateUser({data:{profile_url:I}});e?alert("Error saving avatar: "+e.message):(t.user&&(L.user_metadata.profile_url=t.user.user_metadata.profile_url,H.src=t.user.user_metadata.profile_url),f(),alert("Avatar saved successfully!"))});async function N(){let{data:{user:t}}=await M.auth.getUser();if(!t)return p();let e=l.value.trim(),r=t.user_metadata?.username||t.email;t.is_anonymous&&(r="Guest User");let w=t.user_metadata?.profile_url||I;if(!e)return alert("Message is required.");let A={user_id:t.id,username:r,message:e,profile_url:w,created_at:new Date().toISOString(),likes:0,dislikes:0,emoji:null,topic:q},{error:W}=await M.from("comments").insert([A]);W?(console.error("DATABASE ERROR:",W),alert("Could not post comment. See console for details.")):(l.value="",j())}a.addEventListener("click",N);async function h(t,e){let{data:{user:r}}=await M.auth.getUser();if(!r)return p();let w=r.user_metadata?.username||r.email;r.is_anonymous&&(w="Guest User");let A=r.user_metadata?.profile_url||I,{error:W}=await M.from("comments").insert([{user_id:r.id,username:w,message:e,profile_url:A,created_at:new Date().toISOString(),parent_id:t,likes:0,dislikes:0,emoji:null,topic:q}]);W?(console.error("DATABASE ERROR on reply:",W),alert("Error submitting reply. See console for details.")):j()}function o(t){let e=new Date(t),w=Math.floor((new Date-e)/1e3);return w<60?`${w}s ago`:w<3600?`${Math.floor(w/60)}m ago`:w<86400?`${Math.floor(w/3600)}h ago`:`${Math.floor(w/86400)}d ago`}let n=document.getElementById("customSortDropdown"),g=n.querySelector(".selected-option"),u=n.querySelector(".dropdown-options");g.addEventListener("click",()=>{u.style.display=u.style.display==="block"?"none":"block"}),u.querySelectorAll("li").forEach(t=>{t.addEventListener("click",()=>{u.querySelectorAll("li").forEach(e=>e.classList.remove("active")),t.classList.add("active"),g.innerText=t.innerText,u.style.display="none",S=t.dataset.value==="recent",j()})}),document.addEventListener("click",t=>{n.contains(t.target)||(u.style.display="none")});async function b(t,e){let{data:{user:r}}=await M.auth.getUser();if(!r)return p();let{data:w,error:A}=await M.from("comments").select(e).eq("id",t).single();if(A){console.error(`Error fetching ${e} count:`,A);return}let W=(w[e]||0)+1,{error:U}=await M.from("comments").update({[e]:W}).eq("id",t);U?(console.error(`Error updating ${e} count:`,U),alert(`Could not update ${e}. See console for details.`)):j()}async function j(){let{data:t,error:e}=await M.from("comments").select("*").eq("topic",q).order("created_at",{ascending:!S});if(e){if(e.code==="PGRST116"){document.getElementById("comments-list").innerHTML="",document.getElementById("commentCount").innerText=0;return}return console.error("Error loading comments:",e)}let r=document.getElementById("comments-list");r.innerHTML="";let w=t.filter(U=>!U.parent_id),A=t.filter(U=>U.parent_id),W=(U,ie=!1)=>{let ae=1,te=document.createElement("div"),ne=A.some(X=>X.parent_id===U.id),oe=ie?"comment reply-box":"comment";ne||(oe+=" no-replies"),te.className=oe,te.innerHTML=`
              <div class="comment-header">
                <img src="${U.profile_url}" />
                <div><strong>${U.username}</strong> <small>${o(U.created_at)}</small></div>
              </div>
              <div class="comment-body">${U.message}</div>
              <div class="comment-footer">
                <span class="like-btn" data-id="${U.id}"><i class="bi bi-hand-thumbs-up"></i> <span class="like-count">${U.likes||0}</span></span>
                <span class="dislike-btn" data-id="${U.id}"><i class="bi bi-hand-thumbs-down"></i> <span class="dislike-count">${U.dislikes||0}</span></span>
                <span class="reply-btn" data-id="${U.id}"><i class="bi bi-chat-left-text"></i> Reply</span>
              </div>
              <div class="replies"></div>`;let V=te.querySelector(".replies");return te.querySelector(".like-btn").addEventListener("click",()=>b(U.id,"likes")),te.querySelector(".dislike-btn").addEventListener("click",()=>b(U.id,"dislikes")),te.querySelector(".reply-btn").addEventListener("click",()=>{if(V.innerHTML="",!L)return p();let X=document.createElement("div");X.innerHTML=`<textarea placeholder="What's on your mind?" class="reply-message"></textarea><button class="comment-btn reply-submit">Submit Reply</button>`,V.appendChild(X),X.querySelector(".reply-submit").addEventListener("click",async()=>{let se=X.querySelector(".reply-message").value.trim();se?await h(U.id,se):alert("Reply message required")})}),A.filter(X=>X.parent_id===U.id).forEach(X=>{let se=W(X,!0);se.classList.add(`reply-${ae++}`),V.appendChild(se)}),te};document.getElementById("commentCount").innerText=t.length,w.forEach(U=>r.appendChild(W(U))),C()}function C(){document.querySelectorAll(".comment.reply-box.last-reply").forEach(t=>{t.classList.remove("last-reply")}),document.querySelectorAll(".replies").forEach(t=>{let e=t.querySelectorAll(".comment.reply-box");e.length>0&&e[e.length-1].classList.add("last-reply")})}(async()=>{y(),await k();let{data:{session:t}}=await M.auth.getSession();await m(t),document.querySelectorAll(".reaction").forEach(e=>{e.addEventListener("click",()=>d(e.dataset.reaction))})})()});})();
